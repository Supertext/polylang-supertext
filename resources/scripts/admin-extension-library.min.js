/*!
 * Supertext translation
 * https://wordpress.org/plugins/polylang-supertext/
 * @author Heinrich Muralt
 * @version 1.9.0
 * Copyright 2016 */
var Supertext=Supertext||{};Supertext.Template=function(t,e,n,o){"use strict";function r(t,e){return i.hasOwnProperty(t)||(i[t]=o.template(t)),i[t](e)}var a={orderLinkRow:"sttr-order-link-row",orderProgressBar:"sttr-order-progress-bar",modal:"sttr-modal",modalError:"sttr-modal-error",modalButton:"sttr-modal-button",stepLoader:"sttr-step-loader",contentStep:"sttr-content-step",quoteStep:"sttr-quote-step",confirmationStep:"sttr-confirmation-step"},i={},u={initialize:function(){n.each(a,function(t,e){u[t]=function(t){return r(e,t)}})}};return u}(window,document,jQuery,wp),Supertext.Modal=function(t,e,n){"use strict";function o(t){var o=p.modal(t);n(e.body).append(o),m.$modal=n(f.modal),m.$modal.find(f.modalCloseIcon).click(r),m.$modal.find(f.modalBackground).click(r),m.$modal.show()}function r(){m.$modal.hide(),m.$modal.remove()}function a(t){n(f.modalBodyContent).html(t)}function i(t){var e=++m.noticeCounter,n=p.modalError({token:e,error:t});return m.$modal.find(f.modalNotice).append(n),m.$modal.find(f.modalNoticeDismissIcon).click(function(t){t.preventDefault(),u(e)}),e}function u(t){isNaN(t)?n(f.modalNotice).empty():n(f.modalErrorNotice(t)).remove()}function l(t,e,o){var r=++m.buttonCounter;return n(f.modalFooter).prepend(p.modalButton({token:r,innerHtml:t,type:e})),n(f.modalButton(r)).click(o),r}function s(t){n(f.modalButton(t)).remove()}function c(t){n(f.modalButton(t)).removeClass("button-disabled").prop("disabled",!1)}function d(t){n(f.modalButton(t)).addClass("button-disabled").prop("disabled",!0)}var p,f={modal:"#sttr-modal",modalBodyContent:"#sttr-modal-body-content",modalNotice:"#sttr-modal-notice",modalCloseIcon:".sttr-modal-icon-close",modalBackground:".sttr-modal-background",modalFooter:".sttr-modal-footer",modalNoticeDismissIcon:".notice-dismiss",modalErrorNotice:function(t){return"#sttr-modal-error-"+t},modalButton:function(t){return"#sttr-modal-button-"+t}},m={noticeCounter:0,buttonCounter:0};return{initialize:function(t){p=t.template},open:o,close:r,showContent:a,showError:i,hideError:u,addButton:l,removeButton:s,enableButton:c,disableButton:d}}(window,document,jQuery),Supertext.Validation=function(t){"use strict";function e(t){return n([t])}function n(e){return t.Deferred(function(n){var o=[];return t.each(e,function(t,e){e(function(t){o.push(t)})}),o.length>0?void n.reject(o):void n.resolve()}).promise()}return{check:e,checkAll:n}}(jQuery),Supertext.Polylang=function(t,e,n){"use strict";function o(t){return n.extend(new r,new t)}function r(){this.savedStepElements=[],this.validationRules={},this.nextButtonName=P.next}function a(){1==n("#post-translations").length&&i();var t=n("#title");1==t.length&&t.val().indexOf(P.inTranslationText)>-1&&u()}function i(){n(".pll-translation-column").each(function(){var t=n(this).parent(),e=t.find(".pll-translation-column input").first().attr("id").replace("htr_lang_","");t.after(F.orderLinkRow({targetLanguageCode:e}))})}function u(){n("#post input, #post select, #post textarea").each(function(){n(this).attr("readonly","readonly"),n(this).addClass("input-disabled")}),n("#wp-content-wrap").hide()}function l(){n("<option>").val(q).text(P.offerTranslation).appendTo("select[name='action']"),n("<option>").val(q).text(P.offerTranslation).appendTo("select[name='action2']"),n("#doaction, #doaction2").click(s)}function s(t){var e=n(this).attr("id").substr(2);if(n('select[name="'+e+'"]').val()!==q)return!0;t.preventDefault();var o=[];return n('input[name="post[]"]:checked').each(function(){o.push(n(this).val())}),o.length>0?($.postIds=o,c()):alert(P.alertPleaseSelect),!1}function c(){Q=[o(_),o(O),o(V)],d(),p(),f(),v(),S(1)}function d(){j.open({title:P.modalTitle})}function p(){j.showContent(F.orderProgressBar({}))}function f(){$.cancelButtonToken=j.addButton(P.cancel,"secondary",function(){j.close()})}function m(){$.closeButtonToken=j.addButton(P.close,"secondary",function(){j.close()})}function v(){$.backButtonToken=j.addButton(P.back,"secondary",h)}function g(){Q[$.currentStepNumber-1].validate().fail(x).done(L).done(function(){Q[$.currentStepNumber-1].save(),S($.currentStepNumber+1)})}function h(){S($.currentStepNumber-1)}function S(t){b(t),T(t),y(),Q[t-1].load().always(function(){k(t),B(t)}),$.currentStepNumber=t}function b(){j.disableButton($.nextButtonToken),j.disableButton($.backButtonToken)}function k(t){$.nextButtonToken&&j.removeButton($.nextButtonToken),$.nextButtonToken=j.addButton(Q[$.currentStepNumber-1].getNextButtonName(),"primary",g)}function B(t){return t==Q.length?(j.removeButton($.nextButtonToken),j.removeButton($.backButtonToken),j.removeButton($.cancelButtonToken),void m()):(t<Q.length&&j.enableButton($.nextButtonToken),void(t>1&&j.enableButton($.backButtonToken)))}function y(){n(z.orderStep).html(F.stepLoader({}))}function T(t){n(z.orderProgressBarSteps).each(function(e,o){return e==t-1?void n(o).addClass("active"):void n(o).removeClass("active")})}function x(t){$.validationErrorToken&&L(),$.validationErrorToken=j.showError({title:P.validationError,message:t})}function L(){$.validationErrorToken&&(j.hideError($.validationErrorToken),$.validationErrorToken=null)}function C(t,e){return n.Deferred(function(o){n.get(t,e).done(function(t){return"success"!=t.responseType?(j.showError({title:P.generalError,message:t.body}),void o.reject(t.body)):void o.resolve(t)}).fail(E).fail(o.reject)}).promise()}function w(t,e){return n.Deferred(function(o){n.post(t,e).done(function(t){return"success"!=t.responseType?(j.showError({title:P.generalError,message:t.body}),void o.reject(t.body)):void o.resolve(t)}).fail(E).fail(o.reject)}).promise()}function E(t,e,n){j.showError({title:P.networkError,message:t.status+" "+e,details:n})}function I(t){N()&&!confirm(P.confirmUnsavedArticle)||($.postIds=[n("#post_ID").val()],$.targetLanguageCode=t,c())}function N(){var t,e,o=!1,r="undefined"!=typeof tinyMCE&&tinyMCE.activeEditor;return r&&!r.isHidden()?r.isDirty()&&(o=!0):("undefined"!=typeof fullscreen&&fullscreen.settings.visible?(t=n("#wp-fullscreen-title").val(),e=n("#wp_mce_fullscreen").val()):(t=n("#post #title").val(),e=n("#post #content").val()),"undefined"!=typeof autosaveLast&&(t||e)&&t+e!=autosaveLast&&(o=!0)),o}var D,j,F,R,P,q="orderTranslation",z={orderItemList:".sttr-order-list",orderItemRemoveIcon:".dashicons-no-alt",orderItemRemoveButton:"#sttr-order-remove-item",orderStep:"#sttr-order-step",contentStepForm:"#sttr-content-step-form",orderProgressBarSteps:"#sttr-order-progress-bar li",orderSourceLanguageInput:"#sttr-order-source-language",orderSourceLanguageLabel:"#sttr-order-source-language-label",orderTargetLanguageSelect:"#sttr-order-target-language",orderTargetLanguageOptions:"#sttr-order-target-language option",contentCheckboxes:'.translatable-content-table input[type="checkbox"]',checkedQuote:'input[name="translationType"]:checked',quoteStepForm:"#sttr-quote-step-form"},Q=[],$={currentStepNumber:0};r.prototype={load:function(){return this.savedStepElements.length>0?this.loadSavedStepElements():this.firstLoad()},loadSavedStepElements:function(){var t=this;return n.Deferred(function(e){n(z.orderStep).empty(),n(z.orderStep).append(t.savedStepElements),t.init(),e.resolve()}).promise()},firstLoad:function(){},getNextButtonName:function(){return this.nextButtonName},init:function(){},validate:function(){return R.checkAll(this.validationRules)},save:function(){this.savedStepElements=n(z.orderStep).children(),this.saveData()},saveData:function(){}};var _=function(){function t(t){$.posts=t.body,n(z.orderStep).html(F.contentStep({posts:$.posts,targetLanguageCode:$.targetLanguageCode,languages:P.languages})),c.init()}function e(){var t=n(z.orderItemList+" li a");t.click(a),t.find(z.orderItemRemoveIcon).click(i),n(z.orderItemRemoveButton).click(u),r.call(n(z.orderItemList+" li:first a"))}function o(){R.check(c.validationRules.posts).fail(x).done(L).done(s),1==$.posts.length&&n(z.orderItemRemoveButton).hide()}function r(){var t=n(this),e=n(z.orderItemList+" li.active a");e.length>0&&(n(e.attr("href")).hide(),e.parent().removeClass("active")),n(t.attr("href")).show(),t.parent().addClass("active")}function a(t){t.preventDefault(),r.call(this)}function i(t){t.preventDefault(),l.call(n(this).parent())}function u(t){t.preventDefault(),l.call(n(z.orderItemList+" li.active a")),r.call(n(z.orderItemList+" li:first a"))}function l(){if(1!=$.posts.length){var t=n(this);n(t.attr("href")).remove(),t.parent().remove();var e=t.data("post-id");$.posts=$.posts.filter(function(t){return t.id!=e}),o()}}function s(){var t=$.posts[0].languageCode;n(z.orderSourceLanguageLabel).html(P.languages[t]),n(z.orderSourceLanguageInput).val(t),n(z.orderTargetLanguageOptions).each(function(e,o){var r=n(o);return r.val()===t?void r.hide():void n(o).show()})}var c=this;c.validationRules={posts:function(t){var e=null,o=!0,r=!1;n.each($.posts,function(t,n){0===t?e=n.languageCode:o=o&&n.languageCode==e,r=r||n.isInTranslation}),r&&t(P.errorValidationSomePostInTranslation),o||t(P.errorValidationNotAllPostInSameLanguage)},content:function(t){var e=!1;n(z.contentCheckboxes).each(function(t,o){if(n(o).prop("checked"))return e=!0,!1}),e||t(P.errorValidationSelectContent)},targetLanguage:function(t){""===n(z.orderTargetLanguageSelect).val()&&t(P.errorValidationSelectTargetLanguage)}},c.firstLoad=function(){return C(D.ajaxUrl,{action:"sttr_getPostTranslationData",postIds:$.postIds}).done(t)},c.init=function(){e(),o()},c.saveData=function(){$.contentFormData=n(z.contentStepForm).serializeArray()}},O=function(){function t(t){n(z.orderStep).html(F.quoteStep({options:t.body.options}))}var e=this;e.nextButtonName=P.orderTranslation,e.validationRules={quote:function(t){0===n(z.checkedQuote).length&&t(P.errorValidationSelectQuote)}},e.firstLoad=function(){return w(D.ajaxUrl+"?action=sttr_getOffer",$.contentFormData).done(t)},e.saveData=function(){$.quoteFormData=n(z.quoteStepForm).serializeArray()}},V=function(){function t(t){n(z.orderStep).html(F.confirmationStep({message:t.body.message}))}var e=this;e.firstLoad=function(){return w(D.ajaxUrl+"?action=sttr_createOrder",$.contentFormData.concat($.quoteFormData)).done(t)}};return{initialize:function(t){D=t.context,j=t.modal,F=t.template,R=t.validation,P=t.l10n,D.enable&&("post"==D.screen?a():"edit"==D.screen&&l())},openOrderForm:I}}(window,document,jQuery),jQuery(document).ready(function(){Supertext.Template.initialize(),Supertext.Modal.initialize({template:Supertext.Template}),Supertext.Polylang.initialize({context:Supertext.Context||{enable:!1},modal:Supertext.Modal,template:Supertext.Template,validation:Supertext.Validation,l10n:supertextTranslationL10n})});