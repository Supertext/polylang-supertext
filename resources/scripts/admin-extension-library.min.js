/*!
 * Supertext translation
 * https://wordpress.org/plugins/polylang-supertext/
 * @author Heinrich Muralt
 * @version 2.7.0
 * Copyright 2016 */
var Supertext=Supertext||{};Supertext.Util=function(){String.format||(String.format=function(t){var e=Array.prototype.slice.call(arguments,1);return t.replace(/{(\d+)}/g,function(t,n){return"undefined"!=typeof e[n]?e[n]:t})})}(),Supertext.Template=function(t,e,n,o){"use strict";function r(t,e){return i.hasOwnProperty(t)||(i[t]=o.template(t)),i[t](e)}var a={orderLinkRow:"sttr-order-link-row",orderProgressBar:"sttr-order-progress-bar",modal:"sttr-modal",modalError:"sttr-modal-error",modalButton:"sttr-modal-button",stepLoader:"sttr-step-loader",contentStep:"sttr-content-step",itemContent:"sttr-item-content",quoteStep:"sttr-quote-step",confirmationStep:"sttr-confirmation-step"},i={},l={initialize:function(){n.each(a,function(t,e){l[t]=function(t){return r(e,t)}})}};return l}(window,document,jQuery,wp),Supertext.Modal=function(t,e,n){"use strict";function o(t){var o=m.modal(t);n(e.body).append(o),h.$modal=n(v.modal),h.$modal.find(v.modalCloseIcon).click(r),h.$modal.find(v.modalBackground).click(r),h.$modal.show()}function r(){return h.isFullScreenShown?(n(v.modalFullContent).hide(),void(h.isFullScreenShown=!1)):(h.$modal.hide(),h.$modal.remove(),void n.each(h.closeCallbacks,function(t,e){e.call()}))}function a(t){n(v.modalBodyContent).html(t)}function i(t){n(v.modalFullBodyContent).html(t),n(v.modalFullContent).show(),h.isFullScreenShown=!0}function l(t){var e=++h.noticeCounter,n=m.modalError({token:e,error:t});return h.$modal.find(v.modalNotice).append(n),h.$modal.find(v.modalNoticeDismissIcon).click(function(t){t.preventDefault(),u(e)}),e}function u(t){isNaN(t)?n(v.modalNotice).empty():n(v.modalErrorNotice(t)).remove()}function s(t,e,o){var r=++h.buttonCounter;return n(v.modalFooter).prepend(m.modalButton({token:r,innerHtml:t,type:e})),n(v.modalButton(r)).click(o),r}function c(t){n(v.modalButton(t)).remove()}function d(t){n(v.modalButton(t)).removeClass("button-disabled").prop("disabled",!1)}function f(t){n(v.modalButton(t)).addClass("button-disabled").prop("disabled",!0)}function p(t){h.closeCallbacks.push(t)}var m,v={modal:"#sttr-modal",modalBodyContent:"#sttr-modal-body-content",modalFullContent:"#sttr-modal-full-content",modalFullBodyContent:"#sttr-modal-full-body-content",modalNotice:"#sttr-modal-notice",modalCloseIcon:".sttr-modal-icon-close",modalBackground:".sttr-modal-background",modalFooter:".sttr-modal-footer",modalNoticeDismissIcon:".notice-dismiss",modalErrorNotice:function(t){return"#sttr-modal-error-"+t},modalButton:function(t){return"#sttr-modal-button-"+t}},h={noticeCounter:0,buttonCounter:0,closeCallbacks:[],isFullScreenShown:!1};return{initialize:function(t){m=t.template},open:o,close:r,showContent:a,showFullScreenContent:i,showError:l,hideError:u,addButton:s,removeButton:c,enableButton:d,disableButton:f,onClose:p}}(window,document,jQuery),Supertext.Validation=function(t){"use strict";function e(t){return n([t])}function n(e){return t.Deferred(function(n){var o=[];return t.each(e,function(t,e){e(function(t){o.push(t)})}),o.length>0?void n.reject(o):void n.resolve()}).promise()}return{check:e,checkAll:n}}(jQuery),Supertext.Polylang=function(t,e,n){"use strict";function o(t){return n.extend(new r,new t)}function r(){this.savedStepElements=[],this.validationRules={},this.nextButtonName=Q.next}function a(){1==n("#post-translations").length&&i(),q.isCurrentPostInTranslation&&l()}function i(){n(".pll-translation-column").each(function(){var t=n(this).parent(),e=t.find(".pll-translation-column input").first().attr("id").replace("htr_lang_","");t.after(z.orderLinkRow({targetLanguageCode:e}))})}function l(){n("#post input, #post select, #post textarea").each(function(){n(this).attr("readonly","readonly"),n(this).addClass("input-disabled")}),n("#wp-content-wrap").hide()}function u(){n("<option>").val(U).text(Q.offerTranslation).appendTo("select[name='action']"),n("<option>").val(U).text(Q.offerTranslation).appendTo("select[name='action2']"),n("#doaction, #doaction2").click(s)}function s(t){var e=n(this).attr("id").substr(2);if(n('select[name="'+e+'"]').val()!==U)return!0;t.preventDefault();var o=[];return n('input[name="post[]"]:checked').each(function(){o.push(n(this).val())}),o.length>0?(M.postIds=o,c()):alert(Q.alertPleaseSelect),!1}function c(){A=[o(V),o(G),o(H)],f(Q.orderModalTitle),p(),m(),h(),k(1)}function d(){var t=o(J);f(Q.sendChangesModalTitle),v(),_.showContent(z.stepLoader({})),t.load()}function f(t){_.open({title:t})}function p(){_.showContent(z.orderProgressBar({}))}function m(){M.cancelButtonToken=_.addButton(Q.cancel,"secondary",function(){_.close()})}function v(){_.addButton(Q.close,"secondary",function(){_.close()}),_.onClose(function(){t.location.reload()})}function h(){M.backButtonToken=_.addButton(Q.back,"secondary",S)}function g(){A[M.currentStepNumber-1].validate().fail(w).done(E).done(function(){A[M.currentStepNumber-1].save(),k(M.currentStepNumber+1)})}function S(){E(),D(),N(),k(M.currentStepNumber-1)}function k(t){B(t),y(t),x(),A[t-1].load().done(function(){T(),b(t)}).fail(function(){T()}).always(function(){C(t)}),M.currentStepNumber=t}function B(){_.disableButton(M.nextButtonToken),_.disableButton(M.backButtonToken),_.disableButton(M.cancelButtonToken)}function b(t){M.nextButtonToken=_.addButton(A[t-1].getNextButtonName(),"primary",g)}function T(){M.nextButtonToken&&_.removeButton(M.nextButtonToken)}function C(t){return t==A.length?(_.removeButton(M.nextButtonToken),_.removeButton(M.backButtonToken),_.removeButton(M.cancelButtonToken),void v()):(t<A.length&&_.enableButton(M.nextButtonToken),t>1&&_.enableButton(M.backButtonToken),void _.enableButton(M.cancelButtonToken))}function x(){n($.orderStep).html(z.stepLoader({}))}function y(t){n($.orderProgressBarSteps).each(function(e,o){return e==t-1?void n(o).addClass("active"):void n(o).removeClass("active")})}function w(t){M.validationErrorToken&&E(),M.validationErrorToken=_.showError({title:Q.validationError,message:t})}function E(){M.validationErrorToken&&(_.hideError(M.validationErrorToken),M.validationErrorToken=null)}function I(t,e){return n.Deferred(function(o){n.get(t,e).done(function(t){o.resolve(t)}).fail(F).fail(o.reject)}).promise()}function L(t,e){return n.Deferred(function(o){n.post(t,e).done(function(t){o.resolve(t)}).fail(F).fail(o.reject)}).promise()}function D(){M.ajaxResponseErrorToken&&(_.hideError(M.ajaxResponseErrorToken),M.ajaxResponseErrorToken=null)}function F(t,e,n){M.ajaxErrorToken=_.showError({title:Q.networkError,message:t.status+" "+e+": "+n,details:t.responseJSON})}function N(){M.ajaxErrorToken&&(_.hideError(M.ajaxErrorToken),M.ajaxErrorToken=null)}function j(t){R()&&!confirm(Q.confirmUnsavedPost)||(M.postIds=[q.currentPostId],M.targetLanguageCode=t,c())}function P(){M.targetPostId=q.currentPostId,d()}function R(){var t,e,o=!1,r="undefined"!=typeof tinyMCE&&tinyMCE.activeEditor;return r&&!r.isHidden()?r.isDirty()&&(o=!0):("undefined"!=typeof fullscreen&&fullscreen.settings.visible?(t=n("#wp-fullscreen-title").val(),e=n("#wp_mce_fullscreen").val()):(t=n("#post #title").val(),e=n("#post #content").val()),"undefined"!=typeof autosaveLast&&(t||e)&&t+e!=autosaveLast&&(o=!0)),o}var q,_,z,O,Q,U="orderTranslation",$={orderItemList:".sttr-order-list",orderItemRemoveIcon:".dashicons-no-alt",orderItemRemoveButton:"#sttr-order-remove-item",orderShowItemContentButton:"#sttr-order-show-item-content",orderStep:"#sttr-order-step",contentStepForm:"#sttr-content-step-form",orderProgressBarSteps:"#sttr-order-progress-bar li",orderSourceLanguageInput:"#sttr-order-source-language",orderSourceLanguageLabel:"#sttr-order-source-language-label",orderTargetLanguageSelect:"#sttr-order-target-language",orderTargetLanguageOptions:"#sttr-order-target-language option",contentCheckboxes:'.translatable-content-table input[type="checkbox"]',checkedQuote:'input[name="translationType"]:checked',quoteStepForm:"#sttr-quote-step-form"},A=[],M={currentStepNumber:0};r.prototype={load:function(){return this.savedStepElements.length>0?this.loadSavedStepElements().done(self.init):this.loadData().done(this.saveData).done(this.addStepElements).done(this.init)},loadSavedStepElements:function(){var t=this;return n.Deferred(function(e){n($.orderStep).empty(),n($.orderStep).append(t.savedStepElements),e.resolve()}).promise()},loadData:function(){},saveData:function(t){},addStepElements:function(t){},init:function(){},getNextButtonName:function(){return this.nextButtonName},validate:function(){return O.checkAll(this.validationRules)},save:function(){this.saveForm(),this.savedStepElements=n($.orderStep).children().detach()},saveForm:function(){}};var V=function(){function t(){var t=n($.orderItemList+" li a");t.click(r),t.find($.orderItemRemoveIcon).click(a),n($.orderItemRemoveButton).click(i),n($.orderShowItemContentButton).click(u),o.call(n($.orderItemList+" li:first a"))}function e(){O.check(f.validationRules.posts).fail(w).done(E).done(d),1==M.posts.length&&n($.orderItemRemoveButton).hide()}function o(){var t=n(this),e=n($.orderItemList+" li.active a");e.length>0&&(n(e.attr("href")).hide(),e.parent().removeClass("active")),n(t.attr("href")).show(),t.parent().addClass("active")}function r(t){t.preventDefault(),o.call(this)}function a(t){t.preventDefault(),l.call(n(this).parent())}function i(t){t.preventDefault(),l.call(n($.orderItemList+" li.active a")),o.call(n($.orderItemList+" li:first a"))}function l(){if(1!=M.posts.length){var t=n(this);n(t.attr("href")).remove(),t.parent().remove();var o=t.data("post-id");M.posts=M.posts.filter(function(t){return t.id!=o}),e()}}function u(t){t.preventDefault(),s.call(n($.orderItemList+" li.active a"))}function s(){var t=n(this),e=t.data("post-id");n.when(I(q.ajaxUrl+"?action=sttr_getPostRawData",{postId:e}),L(q.ajaxUrl+"?action=sttr_getPostTranslationData&postId="+e,n($.contentStepForm).serializeArray()),n.each(M.posts,function(t,n){return n.id==e?n:null})).done(function(t,e,n){var o=c(n[0],e);_.showFullScreenContent(z.itemContent({rawData:JSON.stringify(t,null,4),translationData:o}))})}function c(t,e){var n=[];for(var o in t.translatableFieldGroups)if(e.hasOwnProperty(o)){for(var r=t.translatableFieldGroups[o].name,a=[],i=[{path:o,value:e[o]}];i.length>0;){var l=i.pop();if("object"==typeof l.value||"array"==typeof l.value)for(var u in l.value)i.push({path:l.path+"->"+u,value:l.value[u]});else a.push(l)}n.push({name:r,elements:a})}return n}function d(){var t=M.posts[0].languageCode;n($.orderSourceLanguageLabel).html(Q.languages[t]),n($.orderSourceLanguageInput).val(t),n($.orderTargetLanguageOptions).each(function(e,o){var r=n(o);return r.val()===t?void r.remove():void n(o).show()})}var f=this;f.validationRules={posts:function(t){var e=null,o=!0,r=!1;n.each(M.posts,function(t,n){0===t?e=n.languageCode:o=o&&n.languageCode==e,r=r||n.meta.inTranslation}),r&&t(Q.errorValidationSomePostInTranslation),o||t(Q.errorValidationNotAllPostInSameLanguage)},content:function(t){var e=!1;n($.contentCheckboxes).each(function(t,o){if(n(o).prop("checked"))return e=!0,!1}),e||t(Q.errorValidationSelectContent)},targetLanguage:function(t){if(""===n($.orderTargetLanguageSelect).val())return void t(Q.errorValidationSelectTargetLanguage);var e=n($.orderTargetLanguageSelect).val();n.each(M.posts,function(n,o){var r=o.unfinishedTranslations[e];void 0!==r&&t(String.format(Q.alreadyBeingTranslatedInto,o.title,Q.languages[e],r.orderId))})}},f.loadData=function(){return I(q.ajaxUrl,{action:"sttr_getPostTranslationInfo",postIds:M.postIds})},f.saveData=function(t){M.posts=t},f.addStepElements=function(){n($.orderStep).html(z.contentStep({posts:M.posts,targetLanguageCode:M.targetLanguageCode,languages:Q.languages}))},f.init=function(){t(),e()},f.saveForm=function(){M.contentFormData=n($.contentStepForm).serializeArray()}},G=function(){var t=this;t.nextButtonName=Q.orderTranslation,t.validationRules={quote:function(t){0===n($.checkedQuote).length&&t(Q.errorValidationSelectQuote)}},t.loadData=function(){return L(q.ajaxUrl+"?action=sttr_getOffer",M.contentFormData)},t.addStepElements=function(t){n($.orderStep).html(z.quoteStep({wordCount:t.wordCount,language:t.language,options:t.options}))},t.saveForm=function(){M.quoteFormData=n($.quoteStepForm).serializeArray()}},H=function(){var t=this;t.loadData=function(){return L(q.ajaxUrl+"?action=sttr_createOrder",M.contentFormData.concat(M.quoteFormData))},t.addStepElements=function(t){n($.orderStep).html(z.confirmationStep({message:t.message}))}},J=function(){var t=this;t.loadData=function(){return I(q.ajaxUrl,{action:"sttr_sendSyncRequest",targetPostId:M.targetPostId})},t.addStepElements=function(t){_.showContent(z.confirmationStep({message:t.message}))}};return{initialize:function(t){q=t.context,_=t.modal,z=t.template,O=t.validation,Q=t.l10n,q.enable&&("post"==q.screen?a():"edit"==q.screen&&u())},openOrderForm:j,sendSyncRequest:P}}(window,document,jQuery),jQuery(document).ready(function(){Supertext.Template.initialize(),Supertext.Modal.initialize({template:Supertext.Template}),Supertext.Polylang.initialize({context:Supertext.Context||{enable:!1},modal:Supertext.Modal,template:Supertext.Template,validation:Supertext.Validation,l10n:supertextTranslationL10n})});